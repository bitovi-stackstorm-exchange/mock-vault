version: 1.0

description: return a kv store key with a short ttl of a config value

input:
  - secret_name
  - config_value_2fa

vars:
  - kv_key: ""
  - executed_2fa: false

tasks:
  generate_key:
    action: core.echo message="generating key"
    next:
      - when: <% succeeded() and ctx().secret_name = "2fa" %>
        publish:
          - kv_key: "vault_2fa_<% random() %>"
        do: handle_2fa
      - when: <% succeeded() and ctx().secret_name = "" %>
        do: fail
      - when: <% failed() %>
        do: fail

  handle_2fa:
    action: st2.kv.set
    input:
      # key: "vault_2fa_RANDOM_GENERATED"
      key: "<% ctx().kv_key %>"
      # value: "<% ctx().config_value_2fa %>"
      value: "1234"
      ttl: 60
    next:
      - when: <% succeeded() %>
        publish:
          - executed_2fa: true

output:
  - kv_name: <% ctx().kv_key %>
  - executed_2fa: <% ctx().executed_2fa %>