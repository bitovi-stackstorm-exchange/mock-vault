version: 1.0

description: return a kv store key with a short ttl of a config value

input:
  - type
  - config_value_2fa

vars:
  - kv_key: ""
  - types:
    - 2fa

tasks:

  check_type:
    action: core.noop
    next:
      - when: <% succeeded() && ctx.types.contains(ctx().type) %>
        publish:
          - kv_key: "vault_2fa_<% random().replace(regex('0\\.'), '') %>"
        do: "handle_<% ctx().type %>"

        # if type no in types
      - when: <% succeeded() && not ctx.types.contains(ctx().type) %>
        do: fail

  # generate_key:
  #   action: core.noop
  #   next:
  #     - when: <% succeeded() and ctx().type = "2fa" %>
  #       publish:
  #         - kv_key: "vault_2fa_<% random() %>"
  #       do: handle_2fa
  #     - when: <% succeeded() and ctx().type = "" %>
  #       do: fail
  #     - when: <% failed() %>
  #       do: fail

  handle_2fa:
    action: st2.kv.set
    input:
      # key: "vault_2fa_RANDOM_GENERATED"
      key: "<% ctx().kv_key %>"
      # value: "<% ctx().config_value_2fa %>"
      value: "1234"
      ttl: 60
    next:
      - when: <% succeeded() %>

output:
  - kv_name: <% ctx().kv_key %>